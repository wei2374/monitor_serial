#include <stdio.h>
#include <string.h>
#include <unistd.h> // write(), read(), close()
#include "cssl.h"
#include "datex_lib.h"


/* if it is time to finish */
int finished=0;
extern FrameList;
extern FrameLen;
static void process_buffer(int id, uint8_t *buf, int length){
    //printf(" %02X",buf[0]);
    for(int i=0;i<length;i++){
        CreateFrameListFromByte(buf[i]);
    }
    if(FrameLen > 0){
        CreateRecordList();
    }
    
    fflush(stdout);
}


void main(){
    cssl_t *serial;
    cssl_start();
    serial=cssl_open("/dev/ttyUSB0",
                    process_buffer,
                    0,
                    19200,
                    8,
                    2,
                    1);

   //cssl_setflowcontrol(serial, 1, 0);
    uint8_t example_input[] ={0x7E ,0X80 ,0X04 ,0X00 ,0X0B ,0X00 ,0X00 ,0XDC ,0X92 ,0XF0 ,0X5F ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X16 ,0X01 ,0X01 ,0X2C ,0X02 ,0X01 ,0X42 ,0X03 ,0X01 ,0X00 ,0X00 ,0XFF ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0XDC ,0X92 ,0XF0 ,0X5F ,0X4B ,0X00 ,0X00 ,0X00 ,0X00 ,0X12 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X03 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X02 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X03 ,0X00 ,0X00 ,0X00 ,0X03 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X0B ,0X00 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X0C ,0X00 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X0D ,0X00 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X0E ,0X00 ,0X01 ,0X80 ,0X01 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X09 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0XAE ,0X1D ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X20 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X1F ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X02 ,0X00 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X0D ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X0E ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0XB1 ,0X00 ,0XDC ,0X92 ,0XF0 ,0X5F ,0X4B ,0X00 ,0X01 ,0X00 ,0X00 ,0X12 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X4B ,0X00 ,0X00 ,0X00 ,0X00 ,0X12 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X14 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X15 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0XB1 ,0X01 ,0XDC ,0X92 ,0XF0 ,0X5F ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X40 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X09 ,0X03 ,0X0F ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0XCC ,0X14 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0XB1 ,0X02 ,0XDC ,0X92 ,0XF0 ,0X5F ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X03 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X03 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X01 ,0X80 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0X00 ,0XB1 ,0X03 ,0X52 ,0X7E};
    for(int i=0;i<1155;i++){
        process_buffer(1, &(example_input[i]), 1);
    }
    /*
    if (!serial) {
	    printf("%s\n",cssl_geterrormsg());
    }
    unsigned char* prepared_msg;
    int length;

    //stop_60s_request(serial);
    //stop_phdb_request(serial);
    //stop_wave_request(serial);

    //sleep(3);
    prepare_phdb_request(serial);
    
    //sleep(3);
    //prepare_60s_request(serial);

    //stop_phdb_request(serial);
    //stop_60s_request(serial);
    prepare_wave_request(serial);
    

    while (!finished){

	    pause();
    }


    printf("\n^D - we exit\n");

    cssl_close(serial);
    cssl_stop();
    */
}